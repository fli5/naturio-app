<%# Feature 3.1.1 âœ¯  %>
<%# Feature 3.1.2 %>

<% content_for :title, "Shopping Cart - Northern Harvest" %>

<div class="container py-5">
  <%= render 'shared/breadcrumbs', items: [
    { name: 'Home', path: root_path },
    { name: 'Shopping Cart', path: nil }
  ] %>

  <h1 class="h3 mb-4">
    <i class="bi bi-cart3 me-2"></i>Shopping Cart
  </h1>

  <% if @cart_items.any? %>
    <div class="row">
      <!-- Cart Items -->
      <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 50%;">Product</th>
                    <th class="text-center" style="width: 20%;">Quantity</th>
                    <th class="text-end" style="width: 15%;">Subtotal</th>
                    <th class="text-center" style="width: 15%;">Remove</th>
                  </tr>
                </thead>
                <tbody>
                  <% @cart_items.each do |item| %>
                    <tr>
                      <!-- Product Info -->
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="me-3" style="width: 80px;">
                            <% if item[:product].image.attached? %>
                              <%= image_tag url_for(item[:product].image),width:80, 
                                  class: "rounded", alt: item[:product].name %>
                            <% else %>
                              <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                   style="width: 80px; height: 80px;">
                                <i class="bi bi-image text-muted"></i>
                              </div>
                            <% end %>
                          </div>
                          <div>
                            <%= link_to item[:product].name, product_path(item[:product]), 
                                class: "text-decoration-none text-dark fw-bold" %>
                            <div class="text-muted small">
                              <%= number_to_currency(item[:product].price) %> each
                            </div>
                            <% unless item[:product].in_stock? %>
                              <span class="badge bg-danger">Out of Stock</span>
                            <% end %>
                          </div>
                        </div>
                      </td>

                      <!-- Quantity (Feature 3.1.2) -->
                      <td>
                        <%= form_with url: update_item_cart_path(item[:product]), 
                            method: :patch, 
                            local: true,
                            class: "quantity-form" do |f| %>
                          <div class="input-group input-group-sm justify-content-center" style="max-width: 140px; margin: 0 auto;">
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="decrementQty(this)">
                              <i class="bi bi-dash"></i>
                            </button>
                            <%= number_field_tag :quantity, item[:quantity], 
                                min: 1, 
                                max: item[:product].stock_quantity,
                                class: "form-control text-center quantity-input",
                                style: "width: 50px;",
                                data: { max: item[:product].stock_quantity } %>
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="incrementQty(this, <%= item[:product].stock_quantity %>)">
                              <i class="bi bi-plus"></i>
                            </button>
                          </div>
                          <div class="text-center mt-2">
                            <%= f.submit "Update", class: "btn btn-link btn-sm text-success p-0" %>
                          </div>
                        <% end %>
                      </td>

                      <!-- Subtotal -->
                      <td class="text-end fw-bold">
                        <%= number_to_currency(item[:subtotal]) %>
                      </td>

                      <!-- Remove Button (Feature 3.1.2) -->
                      <td class="text-center">
                        <%= button_to remove_from_cart_path(item[:product]), 
                            method: :delete,
                            class: "btn btn-outline-danger btn-sm",
                            data: { turbo_confirm: "Remove #{item[:product].name} from cart?" } do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Cart Actions -->
          <div class="card-footer bg-white d-flex justify-content-between">
            <%= link_to products_path, class: "btn btn-outline-secondary" do %>
              <i class="bi bi-arrow-left me-1"></i> Continue Shopping
            <% end %>
            
            <%= button_to clear_cart_path, 
                method: :delete,
                class: "btn btn-outline-danger",
                data: { turbo_confirm: "Clear all items from cart?" } do %>
              <i class="bi bi-trash me-1"></i> Clear Cart
            <% end %>
          </div>
        </div>
      </div>

      <!-- Cart Summary -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-4">Order Summary</h5>
            
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Items (<%= @cart_items.sum { |i| i[:quantity] } %>)</span>
              <span><%= number_to_currency(@cart_total) %></span>
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Shipping</span>
              <span class="text-success">Calculated at checkout</span>
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Tax</span>
              <span class="text-success">Calculated at checkout</span>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between mb-4">
              <strong>Subtotal</strong>
              <strong class="text-success fs-5"><%= number_to_currency(@cart_total) %></strong>
            </div>

            <!-- Checkout Button -->
            <div class="d-grid">
              <% if customer_signed_in? %>
                <%= link_to checkout_path, class: "btn btn-success btn-lg" do %>
                  <i class="bi bi-lock-fill me-1"></i> Proceed to Checkout
                <% end %>
              <% else %>
                <%= link_to new_customer_session_path, class: "btn btn-success btn-lg" do %>
                  <i class="bi bi-box-arrow-in-right me-1"></i> Login to Checkout
                <% end %>
                <p class="text-center text-muted small mt-2 mb-0">
                  Don't have an account? 
                  <%= link_to "Register", new_customer_registration_path %>
                </p>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Trust Badges -->
        <div class="card border-0 shadow-sm mt-3">
          <div class="card-body text-center">
            <div class="row">
              <div class="col-4">
                <i class="bi bi-shield-check text-success fs-4"></i>
                <p class="small mb-0">Secure</p>
              </div>
              <div class="col-4">
                <i class="bi bi-truck text-success fs-4"></i>
                <p class="small mb-0">Fast Shipping</p>
              </div>
              <div class="col-4">
                <i class="bi bi-arrow-repeat text-success fs-4"></i>
                <p class="small mb-0">Easy Returns</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <% else %>
    <!-- Empty Cart -->
    <div class="text-center py-5">
      <i class="bi bi-cart-x text-muted" style="font-size: 5rem;"></i>
      <h3 class="mt-4">Your cart is empty</h3>
      <p class="text-muted mb-4">Looks like you haven't added any products yet.</p>
      <%= link_to products_path, class: "btn btn-success btn-lg" do %>
        <i class="bi bi-bag me-1"></i> Start Shopping
      <% end %>
    </div>
  <% end %>
</div>

<!-- Quantity Control Script -->
<script>
function decrementQty(button) {
  const input = button.parentElement.querySelector('.quantity-input');
  const value = parseInt(input.value) || 1;
  if (value > 1) {
    input.value = value - 1;
  }
}

function incrementQty(button, max) {
  const input = button.parentElement.querySelector('.quantity-input');
  const value = parseInt(input.value) || 1;
  if (value < max) {
    input.value = value + 1;
  }
}
</script>