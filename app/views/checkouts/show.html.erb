<%# app/views/checkouts/show.html.erb %>
<%# Feature 3.1.3 ✯ - Step 1: 选择配送地址 %>

<% content_for :title, "Checkout - Select Address" %>

<div class="container py-5">
  <%= render 'shared/breadcrumbs', items: [
    { name: 'Home', path: root_path },
    { name: 'Cart', path: cart_path },
    { name: 'Checkout', path: nil }
  ] %>

  <!-- Progress Steps -->
  <%= render 'checkouts/progress', step: 1 %>

  <div class="row">
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <h4 class="mb-0">
            <i class="bi bi-geo-alt me-2"></i>Select Shipping Address
          </h4>
        </div>
        <div class="card-body">
          <% if @addresses.any? %>
            <%= form_with url: review_checkouts_path, method: :get, local: true do %>
              <div class="row g-3">
                <% @addresses.each do |address| %>
                  <div class="col-md-6">
                    <div class="form-check card h-100">
                      <div class="card-body">
                        <input class="form-check-input" type="radio" 
                               name="address_id" 
                               id="address_<%= address.id %>"
                               value="<%= address.id %>"
                               <%= 'checked' if address == @selected_address %>
                               required>
                        <label class="form-check-label w-100" for="address_<%= address.id %>">
                          <span class="badge <%= address.address_type == 'shipping' ? 'bg-primary' : 'bg-secondary' %> mb-2">
                            <%= address.address_type.titleize %>
                          </span>
                          <address class="mb-0">
                            <strong><%= address.street_address %></strong><br>
                            <%= address.city %>, <%= address.province.code %><br>
                            <%= address.postal_code %><br>
                            <small class="text-muted">
                              Tax Rate: <%= number_to_percentage(address.province.total_tax_rate, precision: 2) %>
                            </small>
                          </address>
                        </label>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>

              <hr class="my-4">

              <div class="d-flex justify-content-between">
                <%= link_to cart_path, class: "btn btn-outline-secondary" do %>
                  <i class="bi bi-arrow-left me-1"></i> Back to Cart
                <% end %>
                
                <button type="submit" class="btn btn-success btn-lg">
                  Continue to Review <i class="bi bi-arrow-right ms-1"></i>
                </button>
              </div>
            <% end %>
          <% end %>

          <!-- Add New Address Link -->
          <div class="text-center mt-4 pt-4 border-top">
            <%= link_to address_checkouts_path, class: "btn btn-outline-success" do %>
              <i class="bi bi-plus-lg me-1"></i> Add New Address
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="col-lg-4">
      <%= render 'checkouts/order_summary', cart_items: @cart_items %>
    </div>
  </div>
</div>