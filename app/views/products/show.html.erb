<!-- app/views/products/show.html.erb -->
<!-- Feature 2.3 - 产品详情页 -->

<% content_for :title, "#{@product.name} - Northern Harvest" %>

<div class="container py-4">
  <!-- Breadcrumbs (Feature 4.1.3) -->
  <%= render 'shared/breadcrumbs', items: [
    { name: 'Home', path: root_path },
    { name: 'Products', path: products_path },
    { name: @product.categories.first&.name, path: products_path(category: @product.categories.first&.id) },
    { name: @product.name, path: nil }
  ].compact %>

  <div class="row g-5">
    <!-- Product Image -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="position-relative">
          <% if @product.image.attached? %>
            <%= image_tag url_for(@product.image),width:600,
                class: "card-img-top", 
                alt: @product.name,
                id: "mainImage",
                style: "object-fit: contain; max-height: 500px;" %>
          <% else %>
            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                 style="height: 400px;">
              <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
            </div>
          <% end %>
          
          <!-- Badges -->
          <div class="position-absolute top-0 start-0 p-3">
            <% if @product.on_sale? %>
              <span class="badge bg-danger fs-6 me-1">Sale</span>
            <% end %>
            <% if @product.is_new? %>
              <span class="badge bg-warning text-dark fs-6">New</span>
            <% end %>
          </div>
        </div>
      </div>
      
      <!-- Thumbnail Gallery (如果有多图) -->
      <% if @product.images.attached? && @product.images.count > 1 %>
        <div class="d-flex gap-2 mt-3">
          <% @product.images.each_with_index do |image, index| %>
            <div class="thumbnail-item" style="cursor: pointer;">
              <%= image_tag image.variant(resize_to_limit: [100, 100]), 
                  class: "rounded border #{'border-success border-2' if index == 0}",
                  style: "width: 80px; height: 80px; object-fit: cover;" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Product Details -->
    <div class="col-lg-6">
      <!-- Categories -->
      <div class="mb-2">
        <% @product.categories.each do |category| %>
          <%= link_to category.name, products_path(category: category.id), 
              class: "badge bg-success text-decoration-none me-1" %>
        <% end %>
      </div>
      
      <!-- Product Name -->
      <h1 class="h2 mb-3"><%= @product.name %></h1>
      
      <!-- Price -->
      <div class="mb-4">
        <span class="h2 text-success fw-bold">
          <%= number_to_currency(@product.price) %>
        </span>
        <% if @product.on_sale? %>
          <span class="badge bg-danger ms-2">On Sale!</span>
        <% end %>
      </div>
      
      <!-- Stock Status -->
      <div class="mb-4">
        <% if @product.in_stock? %>
          <span class="text-success">
            <i class="bi bi-check-circle-fill me-1"></i>
            In Stock (<%= @product.stock_quantity %> available)
          </span>
        <% else %>
          <span class="text-danger">
            <i class="bi bi-x-circle-fill me-1"></i>
            Out of Stock
          </span>
        <% end %>
      </div>
      
      <!-- Description -->
      <div class="mb-4">
        <h5>Description</h5>
        <p class="text-muted"><%= @product.description %></p>
      </div>
      
      <!-- Add to Cart Form -->
      <% if @product.in_stock? %>
        <%= form_with url: add_to_cart_path(@product), method: :post, 
            class: "mb-4", data: { turbo: false } do |f| %>
          <div class="row g-3 align-items-end">
            <div class="col-auto">
              <label for="quantity" class="form-label">Quantity</label>
              <div class="input-group" style="width: 140px;">
                <button type="button" class="btn btn-outline-secondary" 
                        onclick="decrementQuantity()">
                  <i class="bi bi-dash"></i>
                </button>
                <%= number_field_tag :quantity, 1, 
                    min: 1, 
                    max: @product.stock_quantity,
                    class: "form-control text-center",
                    id: "quantity" %>
                <button type="button" class="btn btn-outline-secondary" 
                        onclick="incrementQuantity(<%= @product.stock_quantity %>)">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
            <div class="col">
              <%= f.submit "Add to Cart", class: "btn btn-success btn-lg w-100" %>
            </div>
          </div>
        <% end %>
      <% else %>
        <button class="btn btn-secondary btn-lg w-100 mb-4" disabled>
          Out of Stock
        </button>
      <% end %>
      
      <!-- Product Meta -->
      <div class="card bg-light border-0">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-4">
              <i class="bi bi-truck text-success fs-4"></i>
              <p class="small mb-0 mt-1">Free Shipping<br>over $50</p>
            </div>
            <div class="col-4">
              <i class="bi bi-arrow-repeat text-success fs-4"></i>
              <p class="small mb-0 mt-1">Easy<br>Returns</p>
            </div>
            <div class="col-4">
              <i class="bi bi-shield-check text-success fs-4"></i>
              <p class="small mb-0 mt-1">Certified<br>Organic</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  <% if @related_products.any? %>
    <section class="mt-5 pt-5 border-top">
      <h3 class="mb-4">Related Products</h3>
      <div class="row g-4">
        <% @related_products.each do |product| %>
          <div class="col-6 col-md-3">
            <%= render 'shared/product_card', product: product %>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>
</div>

<!-- Quantity Script -->
<script>
function decrementQuantity() {
  const input = document.getElementById('quantity');
  const value = parseInt(input.value) || 1;
  if (value > 1) {
    input.value = value - 1;
  }
}

function incrementQuantity(max) {
  const input = document.getElementById('quantity');
  const value = parseInt(input.value) || 1;
  if (value < max) {
    input.value = value + 1;
  }
}
</script>