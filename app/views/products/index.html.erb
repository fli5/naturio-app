<!-- app/views/products/index.html.erb -->
<!-- Feature 2.1, 2.2, 2.4, 2.5, 2.6-->

<% content_for :title do %>
  <%= @filter_title || @current_category&.name || "All Products" %> - Northern Harvest
<% end %>

<div class="container py-4">
  <!-- Breadcrumbs (Feature 4.1.3) -->
  <%= render 'shared/breadcrumbs', items: [
    { name: 'Home', path: root_path },
    { name: @current_category&.name || @filter_title || 'Products', path: nil }
  ] %>

  <div class="row">
    <!-- Sidebar Filters -->
    <div class="col-lg-3 mb-4">
       <%= render 'shared/search_form' %>
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <!-- Categories Filter (Feature 2.2) -->
          <h6 class="fw-bold mb-3">
            <i class="bi bi-grid me-2"></i>Browse Categories
          </h6>
          <ul class="list-unstyled">
            <li class="mb-2">
              <%= link_to "All Products", products_path, 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:category].blank? && params[:filter].blank?}" %>
            </li>
            <% @categories.each do |category| %>
              <li class="mb-2">
                <%= link_to category.name, products_path(category: category.id), 
                    class: "text-decoration-none #{'fw-bold text-success' if params[:category].to_i == category.id}" %>
                <span class="badge bg-light text-muted"><%= category.products.count %></span>
              </li>
            <% end %>
          </ul>

          <hr>

          <!-- Quick Filters (Feature 2.4) -->
          <h6 class="fw-bold mb-3">
            <i class="bi bi-funnel me-2"></i>Quick Filters
          </h6>
          <ul class="list-unstyled">
            <li class="mb-2">
              <%= link_to products_path(filter: 'on_sale', category: params[:category]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:filter] == 'on_sale'}" do %>
                <i class="bi bi-tag text-danger me-1"></i> On Sale
              <% end %>
            </li>
            <li class="mb-2">
              <%= link_to products_path(filter: 'new', category: params[:category]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:filter] == 'new'}" do %>
                <i class="bi bi-stars text-warning me-1"></i> New Arrivals
              <% end %>
            </li>
            <li class="mb-2">
              <%= link_to products_path(filter: 'recent', category: params[:category]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:filter] == 'recent'}" do %>
                <i class="bi bi-clock me-1"></i> Recently Updated
              <% end %>
            </li>
          </ul>

          <hr>

          <!-- Price Sort -->
          <h6 class="fw-bold mb-3">
            <i class="bi bi-sort-down me-2"></i>Sort By
          </h6>
          <ul class="list-unstyled">
            <li class="mb-2">
              <%= link_to "Newest First", products_path(sort: 'newest', category: params[:category], filter: params[:filter]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:sort] == 'newest' || params[:sort].blank?}" %>
            </li>
            <li class="mb-2">
              <%= link_to "Name (A-Z)", products_path(sort: 'name', category: params[:category], filter: params[:filter]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:sort] == 'name'}" %>
            </li>
            <li class="mb-2">
              <%= link_to "Price: Low to High", products_path(sort: 'price_asc', category: params[:category], filter: params[:filter]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:sort] == 'price_asc'}" %>
            </li>
            <li class="mb-2">
              <%= link_to "Price: High to Low", products_path(sort: 'price_desc', category: params[:category], filter: params[:filter]), 
                  class: "text-decoration-none #{'fw-bold text-success' if params[:sort] == 'price_desc'}" %>
            </li>
          </ul>

          <% if params[:category].present? || params[:filter].present? || params[:search].present? %>
            <hr>
            <%= link_to "Clear All Filters", products_path, class: "btn btn-outline-secondary btn-sm w-100" %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="col-lg-9">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-1">
            <%= @filter_title || @current_category&.name || "All Products" %>
          </h1>
          <p class="text-muted mb-0">
            <%= @products.total_count %> products found
            <% if @search_term.present? %>
              for "<strong><%= @search_term %></strong>"
            <% end %>
          </p>
        </div>
        
        <!-- Mobile Filter Toggle -->
        <button class="btn btn-outline-secondary d-lg-none" type="button" 
                data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas">
          <i class="bi bi-filter"></i> Filters
        </button>
      </div>

      <!-- Products Grid -->
      <% if @products.any? %>
        <div class="row g-4">
          <% @products.each do |product| %>
            <div class="col-6 col-md-4">
              <%= render 'shared/product_card', product: product %>
            </div>
          <% end %>
        </div>

        <!-- Pagination (Feature 2.5) -->
        <div class="d-flex justify-content-center mt-5">
          <%= paginate @products %>
        </div>
      <% else %>
        <!-- Empty State -->
        <div class="text-center py-5">
          <i class="bi bi-search text-muted" style="font-size: 4rem;"></i>
          <h4 class="mt-3">No products found</h4>
          <p class="text-muted">Try adjusting your filters or search terms.</p>
          <%= link_to "View All Products", products_path, class: "btn btn-success" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Mobile Filter Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filters</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <!-- Same filter content as sidebar -->
    <h6 class="fw-bold mb-3">Categories</h6>
    <ul class="list-unstyled">
      <li class="mb-2">
        <%= link_to "All Products", products_path, class: "text-decoration-none" %>
      </li>
      <% @categories.each do |category| %>
        <li class="mb-2">
          <%= link_to category.name, products_path(category: category.id), class: "text-decoration-none" %>
        </li>
      <% end %>
    </ul>
  </div>
</div>